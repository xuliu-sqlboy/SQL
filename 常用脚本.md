# 开发常用

## mysql相关

相关信息

```
MySQL正式库：
1.194.161.226:19833
用户名：root
密码：MThqy@156768


```

<img src="file:///D:/Backup/Pictures/Typedown/011a0307-2170-4197-894f-7c1388752abf.png" title="" alt="011a0307-2170-4197-894f-7c1388752abf" style="zoom:25%;">

### 日期函数

- 取当前时间 并转换格式

```sql
SELECT DATE_FORMAT(NOW(), '%Y%m%d') AS formatted_date;
SELECT DATE_SUB(NOW(), INTERVAL 5 MINUTE);--获取5分钟之前的日期
SELECT DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 5 DAY),'%Y%m%d');


SELECT STR_TO_DATE('2024-11-09', '%Y-%m-%d');
SELECT STR_TO_DATE('09/11/2024 14:30:00', '%d/%m/%Y %H:%i:%s');
SELECT STR_TO_DATE('November 9, 2024', '%M %d, %Y');


ALTER TABLE 合规监控_单据有效时间
MODIFY 更新时间 TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;

```

## 格式转换

CONVERT(expr,type)



DATE    将 value 转化为 DATE 类型。 格式: “YYYY-MM-DD”    
DATETIME    将 value 转化为 DATETIME 类型。格式: “YYYY-MM-DD HH:MM:SS”    
DECIMAL[(M[,D])]    将 value 转化为 DECIMAL 类型。使用可选的 M 和 D 参数指定最大位数（M）和小数点（D）后的位数    
TIME    将 value 转化为 TIME 类型。格式: “HH:MM:SS”    
CHAR    将 value 转化为 CHAR 类型 (固定长度的字符串)    
NCHAR    将 value 转化为 NCHAR (类似 CHAR, 但生成一个具有国家字符集的字符串)    
SIGNED    将 value 转化为 SIGNED (有符号的 64 位整数)    
UNSIGNED    将 value 转化为 UNSIGNED (无符号 64 位整数)    
BINARY    将 value 转化为 BINARY (二进制字符串)    
DOUBLE    将value转化为DOUBLE类型    Added in MySQL 8.0.17
FLOAT    将value转化为FLOAT类型 。    Added in MySQL 8.0.17



## bi相关

### 视图

#### 监控rpa入库流程

```sql

create or replace view v_cdm_table_update_status as

-- cte 表达式 取数据源
with org as (
    select 主体中城市,三级架构 from mt_cdm.组织架构),
-- 01交易额
     yw01 as (
         SELECT distinct '已更新' as tabname,组织结构, DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.各品类日交易额
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')),
     yw03 as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.拼好饭订单
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')

     ),
-- 05商家基础日数据
     yw05 as (
         SELECT distinct '已更新' as tabname,外卖组织结构, DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.商家日基础数据
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')),
-- 06商家月基础数据
     yw06 as (
         SELECT distinct '已更新' as tabname,外卖组织结构, DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.商家月基础数据
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
-- 08 yw08拼好饭商品数据
     yw08sp as (
         SELECT  distinct '已更新' as tabname,
                          代理城市,
                          DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.拼好饭商家日明细
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ) ,
-- yw08拼好饭商家数据
     yw08sj as (
         SELECT  distinct '已更新' as tabname,
                          代理城市,
                          DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.拼好饭商家日汇总
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ) ,



     yw09xd as (
         select distinct
             '已更新' as tabname,
             s.外卖组织结构 as 外卖组织结构,
             DATE_FORMAT(x.更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.新店成长 x
                 left join mt_cdm.商家月基础数据 s
                           on x.商家ID =s.商家ID
         where DATE_FORMAT(x.更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw09xq as (
         select distinct
             '已更新' as tabname,
             s.外卖组织结构 as 外卖组织结构,
             DATE_FORMAT(x.更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.新签详情 x
                 left join mt_cdm.商家月基础数据 s
                           on x.商家ID =s.商家ID
         where DATE_FORMAT(x.更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),


     yw10 as (
         select
             distinct '已更新' as tabname,
                      合作城市,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.神券考核
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw1325 as (
         select
             distinct '已更新' as tabname,
                      城市,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.用户心智
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw13 as (
         select
             distinct '已更新' as tabname,
                      组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.用户心智关键
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')

     ),
     yw14 as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.补贴数据
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw14mon as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.补贴数据月
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     -- yw15拼好饭社群人数
     yw15 as (
         SELECT
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.拼好饭社群
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw22 as (
         SELECT
             distinct
             '已更新' as tabname,
             外卖组织结构,
             DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.月度交易额
         where DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')

     ),

     yw23 as (
         SELECT
             distinct
             '已更新' as tabname,
             s.外卖组织结构  as 外卖组织结构,
             DATE_FORMAT(wl.更新时间,'%Y%m%d') as 更新时间
         FROM mt_cdm.物料拜访 wl
                  left join mt_cdm.商家月基础数据 s
                            on wl.商家id =s.商家ID
         where DATE_FORMAT(wl.更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw23mb as (
         select distinct '已更新' as tabname,
                         bf.合作城市,
                         DATE_FORMAT(mb.更新时间,'%Y%m%d') as 更新时间
         from   mt_cdm.物料陌拜 mb
                    left join mt_cdm.物料拜访 bf
                              on mb.拜访BDmis = bf.实际门店负责人mis号
         where DATE_FORMAT(mb.更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
           and    bf.合作城市 is not null
     ),
     yw24 as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.经营管理日报
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw24pl as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.经营管理日报分品类
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw25 as (
         select
             distinct '已更新' as tabname,
                      城代城市层级,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.配送城市数据
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     ),
     yw30 as (
         select
             distinct '已更新' as tabname,
                      外卖组织结构,
                      DATE_FORMAT(更新时间,'%Y%m%d') as 更新时间
         from
             mt_cdm.红包补贴
         where  DATE_FORMAT(更新时间,'%Y%m%d') = DATE_FORMAT(NOW(), '%Y%m%d')
     )



    -- @allen 新增 后续业务 in 20241031  by allen

-- 关联关系 出看板
select org.主体中城市,org.三级架构,
       case when yw01.tabname is null then '异常' else '已更新' end  as yw01交易额 ,
       case when yw05.tabname is null then '异常' else '已更新' end  as yw05商家日基础数据,
       case when yw06.tabname is null then '异常' else '已更新' end  as yw06商家月基础数据,
       case when  org.三级架构 in ('南召县','哈巴河县','吉木乃县','沙湾','六横镇','隆尧县')  then '未开通'
            when yw08sp.tabname is null then  '异常'
            else '已更新' end  as yw08拼好饭商品数据,
       case when  org.三级架构 in ('南召县','哈巴河县','吉木乃县','沙湾','六横镇','隆尧县')  then '未开通'
            when yw08sj.tabname is null then  '异常' else '已更新' end  as yw08拼好饭商家数据,

       case when  org.三级架构 in ('南召县','哈巴河县','吉木乃县','沙湾','六横镇','隆尧县')  then '未开通'
            when yw15.tabname is null then  '异常' else '已更新' end  as yw15拼好饭社群人数,
       case
           when org.三级架构 in ('南召县', '哈巴河县', '吉木乃县', '沙湾', '六横镇', '隆尧县') then '未开通'
           when yw03.tabname is null then '异常'
           else '已更新'
           end as yw03拼好饭订单 ,
       case
           when yw09xd.tabname is null then '异常'
           else '已更新'
           end as yw09新店成长任务,
       case
           when yw09xq.tabname is null then '异常'
           else '已更新'
           end as yw09新签详情,
       case
           when yw22.tabname is null then '异常'
           else '已更新'
           end as yw22月度交易额,
       case
           when yw10.tabname is null then '异常'
           else '已更新'
           end as yw10神会员,
       case
           when yw30.tabname is null then '异常'
           else '已更新'
           end as yw30红包补贴,
       case
           when yw24.tabname is null then '异常'
           else '已更新'
           end as yw24经营管理日报,
       case
           when yw24pl.tabname is null then '异常'
           else '已更新'
           end as yw24经营管理日报分品类,
       case
           when yw14.tabname is null then '异常'
           else '已更新'
           end as yw14补贴数据,
       case
           when yw14mon.tabname is null then '异常'
           else '已更新'
           end as yw14补贴数据月,
       case
           when yw1325.tabname is null then '异常'
           else '已更新'
           end as yw132点5用户心智,
       case
           when yw13.tabname is null then '异常'
           else '已更新'
           end as yw13用户心智关键数据,
       case
           when yw23mb.tabname is null then '异常'
           else '已更新'
           end as yw23陌拜数据,
       case
           when yw23.tabname is null then '异常'
           else '已更新'
           end as yw23物料拜访,
       case
           when yw25.tabname is null then '异常'
           else '已更新'
           end as yw25配送城市数据

from org
         left join yw01
                   on org.三级架构 = yw01.组织结构
         left join yw03
                   on org.三级架构 = yw03.外卖组织结构
         left join yw05
                   on org.三级架构 = yw05.外卖组织结构
         left join yw06
                   on org.三级架构 = yw06.外卖组织结构
         left join yw08sp
                   on org.三级架构 = yw08sp.代理城市
         left join yw08sj
                   on org.三级架构 = yw08sj.代理城市
         left join yw09xd
                   on org.三级架构 = yw09xd.外卖组织结构
         left join yw09xq
                   on org.三级架构 = yw09xq.外卖组织结构
         left join yw10
                   on org.三级架构 = yw10.合作城市
         left join yw13
                   on org.三级架构 = yw13.组织结构
         left join yw1325
                   on org.三级架构 = yw1325.城市
         left join yw14
                   on org.三级架构 = yw14.外卖组织结构
         left join yw14mon
                   on org.三级架构 = yw14mon.外卖组织结构
         left join yw15
                   on org.三级架构 = yw15.外卖组织结构
         left join yw22
                   on org.三级架构 = yw22.外卖组织结构
         left join yw23
                   on org.三级架构 = yw23.外卖组织结构
         left join yw23mb
                   on org.三级架构 = yw23mb.合作城市
         left join yw24
                   on org.三级架构 = yw24.外卖组织结构
         left join yw24pl
                   on org.三级架构 = yw24pl.外卖组织结构
         left join yw25
                   on org.三级架构 = yw25.城代城市层级
         left join yw30
                   on org.三级架构 = yw30.外卖组织结构

order by 主体中城市


```

|      |       |
| ---- | ----- |
| 临海市  | 340   |
| 六横镇  |       |
| 伊宁市  | 829   |
| 伊川县  | 445   |
| 嵩县   | 124   |
| 庐江县  | 73    |
| 蒙城县  | 3827  |
| 肥东市  | 103   |
| 建德市  | 4331  |
| 呼图壁县 | 4029  |
| 栾城   | 928   |
| 隆尧县  | 3883  |
| 鲁山县  | 1336  |
| 叶县   | 590   |
| 郏县   | 589   |
| 宜阳   | 2398  |
| 淅川县  | 2943  |
| 南召县  | 1988  |
| 克拉玛依 | 4374  |
| 张掖   | 12530 |
| 沙湾   | 12755 |
| 桐乡市  | 3869  |
| 定远县  | 255   |
| 襄城县  | 444   |
| 明光市  | 1350  |
| 哈巴河县 | 14786 |
| 吉木乃县 | 14787 |
| 洛宁   | 914   |
| 桐城市  | 13809 |
| 西平县  | 4322  |
| 栾川   | 749   |
| 鄯善县  | 1561  |

![a2c2296a-17f7-4896-9603-c6c2b8803297](file:///D:/Backup/Pictures/Typedown/a2c2296a-17f7-4896-9603-c6c2b8803297.png)



![df45c182-0808-451a-bb24-80d067ce12bb](file:///D:/Backup/Pictures/Typedown/df45c182-0808-451a-bb24-80d067ce12bb.png)![05c3fa6b-ae27-47e5-9c2d-be6fc2b34562](file:///D:/Backup/Pictures/Typedown/05c3fa6b-ae27-47e5-9c2d-be6fc2b34562.png)

## 参数

```sql
 -- 开始时间 和 结束时间
 and {[DATE_FORMAT(date, '%Y%m%d') >= ${syda}    ]}
 AND {[DATE_FORMAT(date, '%Y%m%d') <= ${eyda}    ]}

 SELECT DATE_FORMAT(NOW(), '%Y%m%d') AS formatted_date;
```

```
^(?!.*#N/A).*$

```



```sql
 TIMESTAMPDIFF(MINUTE, -- 时间 ➖ 时间
                   STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'),
                   lead(fh.下单时间) over (partition by FH.商家ID,fh.日期_公式生成,fh.城市 ORDER BY FH.下单时间 ASC, FH.商家ID desc,FH.城市 desc,FH.日期_公式生成 )) 下单时间间隔,
       count(RPA.客户id) over (partition by fh.城市,replace(substr(fh.日期_公式生成,1,7),'-',''),RPA.客户id) AS 客户ID累计出现次数,
```


