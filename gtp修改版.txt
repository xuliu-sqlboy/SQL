WITH
    OrderDetails AS (
        SELECT
            DT.烽火台订单号 AS 订单号,
            DT.TD人员,
            RPA.客户id,
            FH.日期_公式生成,
            FH.城市,
            fh.商家ID,
            fh.商家名称,
            fh.下单时间,
            STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s') AS formatted_datetime,
            TIMESTAMPDIFF(MINUTE,
                          STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'),
                          LEAD(fh.下单时间) OVER (PARTITION BY FH.商家ID, fh.日期_公式生成, fh.城市 ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) AS 下单时间间隔,
            COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, REPLACE(SUBSTR(fh.日期_公式生成, 1, 7), '-', ''), RPA.客户id) AS 客户ID累计出现次数,
            COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, RPA.客户id, FH.日期_公式生成) AS 当日下单次数,
            CASE
                WHEN ABS(FH.日期_公式生成 - LEAD(fh.日期_公式生成) OVER (PARTITION BY RPA.客户id ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) < 2 THEN '否'
                WHEN ABS(FH.日期_公式生成 - LEAD(fh.日期_公式生成) OVER (PARTITION BY RPA.客户id ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) IS NULL THEN '是'
                ELSE '是'
                END AS 同一客户ID下单间隔天数是否达标,
            COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, RPA.客户id ORDER BY FH.日期_公式生成 ASC RANGE BETWEEN INTERVAL 2 DAY PRECEDING AND CURRENT ROW) AS 近三天出现次数,
            COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, RPA.客户id ORDER BY FH.日期_公式生成 ASC RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW) AS 近七天出现次数,
            CASE WHEN fh.导航距离 >= 1000 THEN '合规' ELSE fh.导航距离 END AS 收餐地址距离商家导航距离,
            CASE WHEN COUNT(DT.城市) OVER (PARTITION BY fh.城市, fh.商家ID, fh.日期_公式生成) < (sj.订单量（GMV） * 0.5) THEN '是' ELSE '否' END AS 单商家当日TD量是否合规,
            CASE
                WHEN (CASE
                          WHEN IFNULL(j30.原价交易额, 0) = 0 OR IFNULL(j30.营业天数, 0) = 0 THEN 0
                          ELSE SUM(FH.订单原价) OVER (PARTITION BY fh.商家ID, fh.日期_公式生成) / j30.原价交易额 / j30.营业天数 - 1
                    END) > 1 THEN '否'
                ELSE '是'
                END AS 单商家当日TD原价GMV是否合规,
            CASE WHEN yc.商家id IS NOT NULL THEN '是' ELSE '否' END AS 是否风控商家,
            fh.订单原价,
            COUNT(FH.订单原价) OVER (PARTITION BY fh.商家ID, fh.日期_公式生成, FH.城市) AS 同一商家TD原价重复次数,
            fh.订单金额,
            CASE
                WHEN IFNULL(fh.订单原价, 0) = 0 THEN 0
                ELSE (fh.订单原价 - fh.订单金额) / fh.订单原价
                END AS 折扣力度,
            FH.骑手,
            FH.送达时间,
            CASE
                WHEN TIMESTAMPDIFF(MINUTE, STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(FH.送达时间, '%Y-%m-%d %H:%i:%s')) >= 20 THEN '合规'
                ELSE TIMESTAMPDIFF(MINUTE, STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(FH.送达时间, '%Y-%m-%d %H:%i:%s'))
                END AS 配送时长,
            CASE
                WHEN TIMESTAMPDIFF(MINUTE, STR_TO_DATE(FH.接单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(fh.取货时间, '%Y-%m-%d %H:%i:%s')) >= 8 THEN '合规'
                ELSE TIMESTAMPDIFF(MINUTE, STR_TO_DATE(FH.接单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(fh.取货时间, '%Y-%m-%d %H:%i:%s'))
                END AS 取餐时长,
            CASE
                WHEN RPA.系统识别骑手到店米 <= 50 THEN '合规'
                ELSE RPA.系统识别骑手到店米
                END AS 骑手上报到店距离,
            CASE
                WHEN RPA.联系顾客 = '是' THEN '是'
                ELSE '否'
                END AS 送达前是否联系客户,
            CASE
                WHEN RPA.改派或转单 = '是' THEN '是'
                ELSE '否'
                END AS 是否有转单或改派情况,
            CASE
                WHEN RPA.骑手已操作送达米 <= 50 THEN '合规'
                ELSE RPA.骑手已操作送达米
                END AS 骑手操作送达距离,
            CASE
                WHEN RPA.骑手已操作送达是否上报异常 = '是' THEN '是'
                ELSE '否'
                END AS 是否有上报异常情况,
            CASE
                WHEN (CASE
                          WHEN RPA.骑手已操作送达米 <= 50 THEN '合规'
                          ELSE RPA.骑手已操作送达米
                          END <> '合规' AND CASE
                                                WHEN RPA.骑手已操作送达是否上报异常 = '是' THEN '是'
                                                ELSE '否'
                                                END = '否')
                    OR
                     CASE
                         WHEN TIMESTAMPDIFF(MINUTE, STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(FH.送达时间, '%Y-%m-%d %H:%i:%s')) >= 20 THEN '合规'
                         ELSE TIMESTAMPDIFF(MINUTE, STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(FH.送达时间, '%Y-%m-%d %H:%i:%s'))
                         END <> '合规'
                    OR CASE
                           WHEN RPA.系统识别骑手到店米 <= 50 THEN '合规'
                           ELSE RPA.系统识别骑手到店米
                           END <> '合规'
                    OR CASE
                           WHEN TIMESTAMPDIFF(MINUTE, STR_TO_DATE(FH.接单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(fh.取货时间, '%Y-%m-%d %H:%i:%s')) >= 8 THEN '合规'
                           ELSE TIMESTAMPDIFF(MINUTE, STR_TO_DATE(FH.接单时间, '%Y-%m-%d %H:%i:%s'), STR_TO_DATE(fh.取货时间, '%Y-%m-%d %H:%i:%s'))
                           END <> '合规'
                    OR CASE
                           WHEN RPA.联系顾客 = '是' THEN '是'
                           ELSE '否'
                           END = '否'
                    OR CASE
                           WHEN RPA.改派或转单 = '是' THEN '是'
                           ELSE '否'
                           END = '是'
                    THEN '否'
                ELSE '是'
                END AS 是否配送合规,
            CASE
                WHEN CASE
                         WHEN ABS(FH.日期_公式生成 - LEAD(fh.日期_公式生成) OVER (PARTITION BY RPA.客户id ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) < 2 THEN '否'
                         WHEN ABS(FH.日期_公式生成 - LEAD(fh.日期_公式生成) OVER (PARTITION BY RPA.客户id ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) IS NULL THEN '是'
                         ELSE '是'
                         END = '否'
                    OR COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, RPA.客户id ORDER BY FH.日期_公式生成 ASC RANGE BETWEEN INTERVAL 2 DAY PRECEDING AND CURRENT ROW) > 2
                    OR COUNT(RPA.客户id) OVER (PARTITION BY fh.城市, RPA.客户id ORDER BY FH.日期_公式生成 ASC RANGE BETWEEN INTERVAL 6 DAY PRECEDING AND CURRENT ROW) > 4
                    OR CASE WHEN fh.导航距离 >= 1000 THEN '合规' ELSE fh.导航距离 END < 1000
                    THEN '否'
                ELSE '是'
                END AS 是否下单合规,
            CASE
                WHEN CASE
                         WHEN COUNT(DT.城市) OVER (PARTITION BY fh.城市, fh.商家ID, fh.日期_公式生成) < (sj.订单量（GMV） * 0.5) THEN '是'
                         ELSE '否'
                         END = '否'
                    OR
                     CASE
                         WHEN (CASE
                                   WHEN IFNULL(j30.原价交易额, 0) = 0 OR IFNULL(j30.营业天数, 0) = 0 THEN 0
                                   ELSE SUM(FH.订单原价) OVER (PARTITION BY fh.商家ID, fh.日期_公式生成) / j30.原价交易额 / j30.营业天数 - 1
                             END) > 1 THEN '否'
                         ELSE '是'
                         END = '否'
                    OR CASE WHEN yc.商家id IS NOT NULL THEN '是' ELSE '否' END = '是'
                    OR COUNT(FH.订单原价) OVER (PARTITION BY fh.商家ID, fh.日期_公式生成, FH.城市) > 2
                    OR TIMESTAMPDIFF(MINUTE, STR_TO_DATE(fh.下单时间, '%Y-%m-%d %H:%i:%s'), LEAD(fh.下单时间) OVER (PARTITION BY FH.商家ID, fh.日期_公式生成, fh.城市 ORDER BY FH.下单时间 ASC, FH.商家ID DESC, FH.城市 DESC, FH.日期_公式生成)) < 20
                    OR (fh.订单原价 > 180)
                    THEN '否'
                ELSE '是'
                END AS 是否商家端合规,
            1.0 / COUNT(客户id) OVER (PARTITION BY 客户id, fh.城市, fh.日期_公式生成) AS 当日不重复客户ID数,
            1.0 / COUNT(客户id) OVER (PARTITION BY 客户id, fh.日期_公式生成) AS 当日公司不重复客户ID数,
            sj.一级品类,
            sj.二级品类,
            CASE WHEN sj.一级品类 IN ('美食', '甜点', '饮品') THEN '是' ELSE '否' END AS 是否为餐饮,
            CASE WHEN FH.城市 IS NOT NULL THEN '是' ELSE '否' END AS 是否TD订单
        FROM mt_cdm.合规监控_填报_地推订单 DT
                 LEFT JOIN mt_cdm.合规监控_填报_烽火台已送达订单 FH ON dt.烽火台订单号 = fh.订单号
                 LEFT JOIN mt_cdm.合规监控_rpa执行结果表 RPA ON RPA.订单号 = DT.烽火台订单号
                 LEFT JOIN mt_cdm.商家日基础数据 sj ON fh.商家ID = sj.商家ID AND STR_TO_DATE(REPLACE(sj.日, '-', ''), '%Y%m%d') = SUBDATE(STR_TO_DATE(REPLACE(fh.日期_公式生成, '-', ''), '%Y%m%d'), INTERVAL 1 DAY)
                 LEFT JOIN (
            SELECT
                b.外卖组织结构,
                b.一级商家配送类型,
                b.一级品类,
                b.二级品类,
                b.三级品类,
                b.商家类型,
                b.代理商家分级标签 AS '分级',
                a.营业天数,
                a.商家ID,
                b.商家名称,
                b.合作BD AS 'BD',
                a.`过去30天`,
                a.`原价交易额`,
                a.`实付交易额`,
                a.`订单量`
            FROM (
                     SELECT
                         CONCAT(DATE_SUB(CURDATE(), INTERVAL 30 DAY), '至', DATE_SUB(CURDATE(), INTERVAL 1 DAY)) AS '过去30天',
                         `商家ID`,
                         COUNT(1) AS '营业天数',
                         ROUND(SUM(原价交易额（GMV）), 2) AS 原价交易额,
                         ROUND(SUM(实付交易额（GMV）), 2) AS 实付交易额,
                         SUM(订单量（GMV）) AS 订单量
                     FROM `商家日基础数据`
                     WHERE STR_TO_DATE(`日`, '%Y%m%d') >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
                     GROUP BY `商家ID`
                 ) a
                     LEFT JOIN `商家组织架构` b ON a.`商家ID` = b.`商家ID`
        ) j30 ON fh.商家ID = j30.商家ID
                 LEFT JOIN mt_cdm.异常商家明细_月 yc ON fh.商家ID = yc.商家ID AND DATE_FORMAT(DATE_SUB(fh.日期_公式生成, INTERVAL 1 MONTH), '%Y%m') = DATE_FORMAT(STR_TO_DATE(CONCAT(yc.月, '01'), '%Y%m%d'), '%Y%m')
        WHERE 1 = 1
          AND dt.烽火台订单号 NOT IN (SELECT 合规监控_填报_取消的订单.订单号 FROM mt_cdm.合规监控_填报_取消的订单)
          AND dt.城市_公式生成 <> '暂无匹配项'
          AND dt.status = 1
    )
SELECT
    订单号,
    TD人员,
    客户id,
    日期_公式生成,
    城市,
    商家ID,
    商家名称,
    下单时间,
    formatted_datetime,
    下单时间间隔,
    客户ID累计出现次数,
    当日下单次数,
    同一客户ID下单间隔天数是否达标,
    近三天出现次数,
    近七天出现次数,
    收餐地址距离商家导航距离,
    单商家当日TD量是否合规,
    单商家当日TD原价GMV是否合规,
    是否风控商家,
    订单原价,
    同一商家TD原价重复次数,
    订单金额,
    折扣力度,
    骑手,
    送达时间,
    配送时长,
    取餐时长,
    骑手上报到店距离,
    送达前是否联系客户,
    是否有转单或改派情况,
    骑手操作送达距离,
    是否有上报异常情况,
    是否配送合规,
    是否下单合规,
    是否商家端合规,
    当日不重复客户ID数,
    当日公司不重复客户ID数,
    一级品类,
    二级品类,
    是否为餐饮,
    是否TD订单
FROM OrderDetails




